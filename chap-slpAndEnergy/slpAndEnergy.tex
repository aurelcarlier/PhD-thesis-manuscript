\chapter{The Station Location Problem and energy aspects} \label{chap:slp}
\begin{bibunit}[ieeetr]
\minitoc
\vspace{2cm}

\noindent
\begin{minipage}[c]{0.25\linewidth}
\flushleft
\includegraphics[width=\linewidth]{stationLocations}
\end{minipage}
\hfill
\begin{minipage}[c]{0.8\linewidth}
\begin{abstract}
This chapter is dedicated to the study of the Station Location Problem (SLP).
The problem, its challenges and related work are first described.
We then present a mathematical program expanding the SDP model seen in Chapter \ref{chap:sdp} and including new features in the model like the number of jockeys.
Next section is dedicated to the integration of energy components in the model.
After having exhibited some modelling issues with respect to the previously developed model, a enhanced linear program is presented.
The latter includes battery range and power supply constraints.
The chapter terminates giving some discussions and improvements about the model.
More particularly, an heuristic is detailed and a basic example illustrates its mechanics.
\end{abstract}
\end{minipage}

\newpage
\section{Introduction}
We have presented in Chapter \ref{chap:sdp} a mathematical linear program resolving the system dimensioning problem.
The optimization dealt with the optimal sizing of a carsharing system when stations were fixed.
The optimal flow circulating in the Time Expanded Graph (TEG) can be interpreted as vehicle routes and some global dimensioning parameters can be deduced from it.
Until then, the problem was to assess the number of vehicles as well as the number of vehicle relocations to run the carsharing system at its better efficiency, considered in this work as the capacity to fulfil the higher number of demands.
In this chapter, we intend to enhance the initial problem with two new challenged aspects.

\medskip
The first one deal with stations' locations.
We propose to look at the problem from a different perspective by expanding its scope to the selection of a subset of stations contributing to the better system configuration.
It involves changing the concept of \emph{station} to \emph{possible station location} which can be also understood as \emph{possible carsharing station site}.
Then, the problem can be expressed as follow: among all possible $\nbStations$ station's locations, what is the number of $P \leq \nbStations$ sites constituting the most effective carsharing system?
From this perspective, we intend to study the decisional factor that lead to select, or not select, a site.
Our expectation is to deduce from exact solutions a global scheme that could inquire the site selection without having to run an exact optimization.

\medskip
The second challenge aims at introduce energy components.
In the previous model, vehicles were able to transport customers from station to another without limiting the total distance they travel during the day or even during a specific trip.
Nowadays, combustion cars can travelled hundred of kilometres a day without the need to refill in gasoline.
Moreover, no specific infrastructure is required to accommodate such vehicles.
In that sense, we assumed that vehicles were considered as combustion vehicles in our previous work.

During the last few decades, numerous environmental issues have motivated the development of alternative means of transportation.
In the world of private vehicles, electric cars has regained a high interest.
Carsharing operators has begun to introduce electric vehicles (EVs) in their fleet and equip station parking slots with charging points.
Some of them (\eg Autolib) even propose a vehicle fleet exclusively composed of electric cars.
In this chapter, our objective is to measure the \emph{operational} impact of running a carsharing system with electric cars.
For the most part, we wish to address the following questions:
\begin{enumerate}
\item Is the lower range of an EVs really limits the global system efficiency?
\item Is the size of the electric battery well suited for carsharing usage?
\item What is the impact of the charging points' power supply?
\end{enumerate}
Including battery range constraints means control their charge level at all times so that a trip can only be performed if the vehicle have sufficient energy to do it.
Until then, the flow model based on TEGs describes macroscopic flows of vehicles.
Even if individual vehicle routes can be extracted, the numerous possible interpretations lead us to adapt and propose an alternative mathematical model able to consider electric cars and their appropriate functional equipment.

\bigskip
This chapter is organized as follow.
The first section specifies the addressed problem and its associated constraints.
Its formulation as a Mixed Integer Linear Program (MILP) is especially presented.
Related variables and constraints are listed and discussed.
Two mathematical models are provided and a master-slave scheme with respect to the system dimensioning problem is exhibited.

Then, section \ref{sec:addingEnergy} presents how to integrate energetic components into the current models.
Considering electric vehicles instead of cars propelled by combustion engines bring interesting challenges that can not be tackled with the actual models.
Thus, after having selected the components we wish include and described the required graph transformations, a new enhanced linear program is exposed.

The chapter terminates giving some modelling improvements to reduce the graph density and the total number of variables.
To cope with solver capabilities, a greedy heuristic is proposed and illustrated on a basic example.

% We study their impact in the global system optimization and discuss .
%of considering electric vehicles on
%Is this type of vehicle intended to be use as strict mobility purposes or can we consider another use in an intelligent territory?

\section{The Station Location Problem}
A major difficulty for an operator wishing to set up a carsharing systems is without any doubt the stations' locations over the area he wishes to cover.
Assuming that potential stations' sites could be identified, the remaining problem of select the ones leading to a system that operates efficiently and captures the higher number of requests stills remain a tricky question.
From a formal point of view, the problem is purely combinatorial and admits $\binom{\nbStations}{\nbMaxStations}$ possible solutions, where $\nbMaxStations$ denotes the number of stations to chose among the $\nbStations$ number of potential stations' sites.


\medskip
We have seen previously that the System Dimensioning Problem (SDP) assumed fixed stations in its statement.
In a way, the SLP will consist in relaxing this assumption and appending some decisions over the stations' locations.
Its formulation will thus sounds very close to the SDP and can be stated as follow.

\paragraph{Station Location Problem [SLP]:}
Given a set of $\nbStations$ carsharing stations' sites, it consists in select the subset of $\nbMaxStations \leq \nbStations$ possible stations' sites allowing the system to run at its maximum potential, \ie satisfying the higher number of demands.

\medskip
Inputs are very similar to the SDP.
The major difference concerns the carsharing stations which are not longer fixed but are now considered as potential stations' sites.
We assumed that a maximum capacity (\ie maximum number of parking lots) could still be known for each site.
Input sets are summarized in the following:
\begin{itemize}
\item $\timeStepSet$: the set of $\nbTimeSteps$ time-steps;
\item $\stationSet$: the set of $\nbStations$ potential stations' sites;
\item $\sCapaSet$: the sites' maximum capacities;
\item $\demandSet$: the set of carsharing demands among stations' sites over time;
\item $\travelTimeSet$: the set of travel times expressed in time-steps.
\end{itemize}
Similarly to the SDP, sets $\demandSet$ and $\travelTimeSet$ are defined as triplets $(i,j,t) \in \stationSet^2 \times \timeStepSet$ where $i$ and $j$ denotes respectively the site of departure and destination and $t$ the time-step of departure.
The problem also considers some system limitations bounds.
The maximum number of selected stations' sites will be denoted by $\nbMaxStations$.
The number of vehicle relocations operations and the number of vehicles are bounded respectively as before to the non-zeros integer values $\nbVROs$ and $\nbVehicles$.
Finally, we also included another feature dealing with the maximum number of jockeys (employees of the carsharing operator).
We refer to $\nbMaxJockeys \in \N$ as the number of jockeys allowing to relocate vehicles at the same time.


\subsection{Related work}

Clearly, the performance of a station-based carsharing system is highly dependent on its station locations.
Determining the suitable places where vehicles will be available is probably a key factor of its success.
To the best of our knowledge, very few studies have been conducted on this particular topic.

% 1. stations locations
\medskip
\cite{ion_site_2009} proposed a dedicated multi-criteria analysis taking into account demographic economic indicators to extend an existing carsharing service located in La Rochelle, France.
Each potential station site is evaluated with a score depending on the preferences of people living in the proximity area and calibrated from a real user survey using fuzzy logic.
The authors stated that the resulted classification can be used in complement with the knowledge of specialists to help decision makers (urban planners, local authorities) not only for carsharing systems but also for bus station locations or bike-sharing services.


\medskip
A recent study conducted by Correia and Antunes \cite{correia_optimization_2012} in 2012, inspired by \cite{fan_carsharing_2008}, proposed three MIP models to find the convenient choice of locations, number and size of stations with respect to different operating schemes.
The objective was to maximize the operator profit taking into account all the revenues (price paid by clients) and costs involved (vehicle depreciation, vehicle maintenance and parking maintenance).
Applied on the city of Lisbon, Portugal, the results showed that the model where the carsharing operator has full control over trip selection is the one which yield the maximum profit.
This was expected since it was the scheme offering the most freedom.
The authors concluded that satisfying all the demand does not make sense economically and lead to severe financial looses for the private operator, even when customer trips are charged with a high price.
Indeed, to reach this level of service the operator need to increase drastically its fleet size and consequently most vehicles stay idle (parked in station) during a large part of the day.
As a consequence, the trip selection ability (\ie the possibility to accept or refuse a request) seems to be crucial to achieve positive profits.
Last, but not least, the authors also proved that the planning of stations location is intuitively dependent on the existence or non-existence of relocation operations which could mitigate the effect of an uneven trip pattern and so allow the supply to expand.

%They also concluded that manage the imbalance situation (only at the end of each days in this study) is the key in a scenario where all demand should be satisfied, even if the client is charged a very high price.
%%%%%%%%%%%%%%%

In another publication, \cite{correia_added_2014} reused their real data set of Lisbon, Portugal, to analyse the impact of a better user flexibility on the operator's profit.
They observed that vehicles are used more often when more information is provided to the user about vehicle availability at different stations of the system.
However, they also noticed that those better operational results came with a greater walking and total travel times.


\medskip
In general, the problem of locating carsharing stations has been addressed through a system management perspective.
and most approaches use a mathematical programming formulation.
Distinctions are made on objectives and operational constraints.
According to studies, some are economically oriented trying to maximize the operator revenue or minimize global costs whereas others are more oriented toward the user satisfaction maximizing the service level.
The overall system optimization is generally limited by budget constraints and system dynamics such as vehicle relocation operations and parking places in each station locations.
Schematically, the problem is viewed through two perspective: minimizing global costs while satisfying all the demand, and maximizing the service level under budget constraints.

\medskip
The main stated drawback with these MIP approaches concerns the limitations of computation times and solver capability due to the problem complexity.
In most cases, as the size of the problem increases, the total number of variables become unsustainable and some simplifications are often necessary.
As far as we know, integrating several decisions into the same problem in a real case study context is still a real challenge in this field.

% 2. jockeys ?

%One-way carsharing allows to study various problems.
%The first one is the number, the position and the size of the stations.
%The sizing and station location problems were studied using MILP model \cite{rickenberg_decision_2013}.
%
%They all use mathematical integer programming (MIP) models and thus are limited because of the hard complexity of this problem.


\subsection{Problem modelling}

The SLP appears as a master problem of the SDP.
It enhances decisions on the selection of potential carsharing sites under the scope of the system dimensioning problem.
As a consequence, the model used previously for the SDP seems well suited and will need some adaptations to deal with the SLP.
The following sections describe the added variables and constraints as well as the graph modifications.

\subsubsection{Decision variables}

In this problem, selecting stations constitutes the main decisions.
Using the previous model, it can be achieved by adding a new group of binary variables for each potential carsharing site standing for its selection in the solution.
Let thus $b = (b_i)_{i \in \{1,\dots, \nbStations\}} \in \{0, 1\}^\nbStations$ be the decisional vector of this problem, define for all $i \in \stationSet$ as:
\medskip
\begin{numcases}{b_i=}
1 & if the station's site $i$ is selected, \nonumber \\
0 & otherwise. \nonumber
\end{numcases}

\medskip
Every vector value represents a unique system configuration.
It is easy to observed here that the SDP is actually a SLP sub-problem when $b$ is fixed to a value in $\{0, 1\}^\nbStations$.
The total number of active stations, $\nbMaxStations$, is the number of ones in $b$.
It can be obtained using $\nbMaxStations = \sum_{i=1}^\nbStations b_i$.
Every instance of the SDP with $\nbMaxStations$ stations correspond to an instance of the SLP where $b$ contains $\nbMaxStations$ ones.

\subsubsection{Constraints}
First, note that limiting the number of selected sites can be easily expressed by bounding the number of ones in $b$ to $\nbMaxStations$.
Formally, the constraint can be written as follow:
\begin{equation} \label{const:nbMaxStations}
\sum_{i=1}^\nbStations b_i \leq \nbMaxStations
\end{equation}

\medskip
Secondly, the limitation of the number of opened sites implies to close some of them.
When a carsharing site is closed, no vehicle can stop or either pass through it.
In our model, vehicles are represented as flows and until then, no restriction on the possibility to enter the nodes have been considered.
Using the new decisional vector $b$, it is now easy to limit the inner (\resp outer) flow entering (\resp leaving) each nodes (carsharing sites).
These constraints are defined as follows:
\begin{align}
\varphi(a) \leq b_{\eta(x)} \cdot \tegCapacity(a) \quad & , \forall a = (x, y) \in \tegArcSet \label{const:stationInnerFlow} \\
\varphi(a) \leq b_{\eta(y)} \cdot \tegCapacity(a) \quad & , \forall a = (x, y) \in \tegArcSet_2 \cup \tegArcSet_3 \label{const:stationOuterFlow}
\end{align}
Constraints (\ref{const:stationInnerFlow}) limit the outer flow in every arcs of the TEG to the arc's capacity if the site is selected and zero otherwise.
Similarly, if the site is active, constraints (\ref{const:stationOuterFlow}) bound the inner flow to the arc's capacity but only for demand and vehicle relocation arcs.
In order not to be redundant with the previous group of constraints, only arcs where the departure station is different from the arrival station have to be considered.
The TEG stock arcs are thus not involved.
In addition, note that this restriction could also be appropriate to some specific demand patterns like round-trip demands for instance.

\medskip
As introduced before, \emph{jockeys} are essential to operate vehicle relocation operations although they constitute an additional financial charge for the operator.
They represent the operator-based approach to balance vehicle stocks through the system and correspond to periodic relocation of vehicles among stations by staff members, also known as \emph{jockeys}.

In this work, we intend to limit the total number of jockeys working for the carsharing operator.
To do so, we simply bound the number of vehicle relocations made at the same time.
Recall first that $\relocTimeStepSet$ denotes the subset of time-steps when vehicles start to be relocated (previously defined in chapter \ref{chap:sdp}, page \pageref{def:relocTimeStepSet}).
For clarity reasons, let $\tegArcSet_3^t$ be the set of relocation arcs starting their operation at time $t \in \relocTimeStepSet$.
Formally:
\begin{equation}
\tegArcSet_3^t = \{a = (x, y) \in \tegArcSet_3 \mid \theta(x) = t\}
\end{equation}
Then, the constraint under the maximum number of simultaneous vehicle relocation operations, denoted by $\nbMaxJockeys$, follows:
\begin{equation} \label{const:nbJockeys}
\sum_{a \in \tegArcSet_3^t} \varphi(a) \leq \nbMaxJockeys \quad, \forall t \in \relocTimeStepSet
\end{equation}


\subsubsection{Outputs and Solution}
A solution to the SLP consists of assigning a stations' configuration to the carsharing system, \ie settle the value of $b \in \{0, 1\}^\nbStations$ satisfying constraint (\ref{const:nbMaxStations}).
For any fixed value of $b$, which means that the stations' locations are now fixed, we can solve the system dimensioning problem upgraded with the limitation under the number of jockeys (constraint group \ref{const:nbJockeys}).
Its resolution gives the maximum number of demands this station configuration is able to fulfil.
Then, the optimal solution of the SLP is the vector $b \in \{0, 1\}^\nbStations$ maximizing the system efficiency for fixed values of the maximal number of vehicles, vehicle relocation operations and jockeys.
%The number of vehicles as well as the vehicles' routes the and the vehicle relocation plan can also be part of the solution.
The expected outputs of the problem resolution are listed below:
\begin{itemize}
\item a system configuration, \ie a value $b \in \{0, 1\}^\nbStations$,
\item the vehicles' routes through the system.
\end{itemize}

\medskip
As for the system dimensioning problem, we can extract a lot of information from vehicles' routes.
Those extended outputs can be deduced from any solution and are summarized in the following:
\begin{itemize}
\item the total number of stations, vehicles and jockeys;
\item the set of satisfied demands;
\item the set of vehicle relocation to be operate during the period;
\item the number of parking places in each station.
\end{itemize}

\subsection{Mathematical program}
To cope with the station location problem, we opted for the linear programming approach.
The mathematical model presented thereafter is based on a enhanced model of the system dimensioning problem described in Chapter \ref{chap:sdp}.
The later is actually a solid basis since the two problems are linked to each other.
They both rely on the time expanded graph model presented before.
This time, nodes represent possible location sites for carsharing stations and a fixed number of jockeys is involved as a constraint in vehicle relocation operations.
As such, they are a limit factor affecting the global optimization.
Basically, the mathematical program reused the transportation network expanded over time (TEG) and its associated constraints.

\medskip
We present in this section two sights of seeing the model.
The first one aims at highlighting the sub-problem dependence between the SDP and the SLP.
Then, the full version is detailed.

\subsubsection{The master-slave scheme}
As seen in chapter \ref{chap:sdp}, an instance of the {\SDP} could be written as $\text{SDP}(\timeStepSet, \stationSet, \sCapaSet, \demandSet, \travelTimeSet, \nbVROs, \nbVehicles)$.
This definition can be generalized to consider different station configurations.
The idea is to use the vector $b$ as a component selector of the station set $\stationSet$.
%So, let first defined $\stationSet(b)$, the set of stations' sites conditioned by vector $b$.
\begin{equation} \label{eq:subStationSet}
\stationSet(b) = \{ s_i \in \stationSet, i\in \{1, \dots, \nbStations\} \mid b_i=1\}
\end{equation}

Now, we clearly have $\stationSet(b) \subseteq \stationSet$, for any value of $b$.
According to Equation \eqref{eq:subStationSet}, each value of $b$ generates a fixed subset of stations picked in $\stationSet$.
The initial set corresponds to the situation where $b=1$.
%In the following we refer to $\text{SDP}^\star(\timeStepSet, \stationSet(b), \sCapaSet, \demandSet, \travelTimeSet, \nbVROs, \nbVehicles)$ as the maximum number of demands the optimal system configuration of the SDP instance resolution have given.
As a master problem, the SLP can now be formally expressed.
\begin{equation}\label{obj:master-slave}
\text{[SLP]:} \max\limits_{b \in \{0, 1\}^\nbStations} \text{SDP}^\star(\timeStepSet, \stationSet(b), \sCapaSet, \demandSet, \relocTimeStepSet, \travelTimeSet, \nbVROs, \nbVehicles)
\end{equation}
\begin{numcases}{s.t.}
\sum_{i=1}^\nbStations b_i \leq \nbMaxStations \label{constr:MS:nbStations}\\
\varphi(a) \leq b_{\eta(x)} \cdot \tegCapacity(a) &$\forall a = (x, y) \in \tegArcSet$ \label{constr:MS:stationInnerFlow} \\
\varphi(a) \leq b_{\eta(y)} \cdot \tegCapacity(a) &$\forall a = (x, y) \in \tegArcSet_2 \cup \tegArcSet_3$ \label{constr:MS:stationOuterFlow}\\
\sum_{a \in \tegArcSet_3^t} \varphi(a) \leq \nbMaxJockeys &$\forall t \in \relocTimeStepSet$ \label{constr:MS:nbJockeys}\\
\varphi(a) \in \N & $\forall a\in\tegArcSet$ \label{constr:MS:varFlows}\\
b_i \in \{0, 1\} & $\forall i \in \{1, \dots, \nbStations\}$ \label{constr:MS:varStations}
\end{numcases}

\medskip
Equation \eqref{obj:master-slave} stands for the maximization of the demand.
The value $\text{SDP}^\star$ returns the maximal number of demands the resolution of the SDP linear program for the specific configuration given as parameter.
Equation \eqref{constr:MS:nbStations} limits the total number of carsharing sites to $\nbMaxStations$.
Equation \eqref{constr:MS:stationInnerFlow} (\resp Equation \eqref{constr:MS:stationOuterFlow}) prevents an inner flow (\resp outer flow) to pass through a node if not active.
Equation \eqref{constr:MS:nbJockeys} limits the number of simultaneous vehicle relocation operations to $\nbMaxJockeys$.
Finally, Equations \eqref{constr:MS:varFlows} and \eqref{constr:MS:varStations} define the variables' domains.

\subsubsection{The mathematical program}
The detailed linear program of the {\SLP} is given bellow.

\begin{equation}\label{obj:SLP:maxDemands}
\text{[SLP]:} \max ~~\sum_{\substack{a\in \tegArcSet_2}} \varphi(a)
\end{equation}
\begin{numcases}{s.t.}
\sum_{i=1}^\nbStations b_i \leq \nbMaxStations \label{constr:SLP:nbStations}\\
\varphi(a) \leq b_{\eta(x)} \cdot \tegCapacity(a) & $\forall a = (x, y) \in \tegArcSet$ \label{constr:SLP:stationInnerFlow} \\
\varphi(a) \leq b_{\eta(y)} \cdot \tegCapacity(a) & $\forall a = (x, y) \in \tegArcSet_2 \cup \tegArcSet_3$ \label{constr:SLP:stationOuterFlow}\\
\sum_{a \in \tegArcSet_3^t} \varphi(a) \leq \nbMaxJockeys & $\forall t \in \relocTimeStepSet$ \label{constr:SLP:nbJockeys}\\
\sum_{a \in \tegArcSet_3} \varphi(a) \leq \nbVROs \label{constr:SLP:nbVROs}\\
\sum_{a\in \tegArcSet} \varphi(a) \cdot \epsilon_a \leq \nbVehicles \label{constr:SLP:nbVehicles}\\
\varphi(a) \leq u(a) & $\forall a \in \tegArcSet$ \label{constr:SLP:arcCapacities}\\
\sum_{\substack{y\in \Gamma^-(x)}} \varphi((y,x)) = \sum_{\substack{y\in \Gamma^+(x)}} \varphi((x,y)) & $\forall x \in \tegNodeSet$ \label{constr:SLP:flowConservation}\\
\varphi(a) \in \N & $\forall a\in\tegArcSet$ \label{constr:SLP:varFlows}\\
b_i \in \{0, 1\} & $\forall i \in \{1, \dots, \nbStations\}$ \label{constr:SLP:varStations}
\end{numcases}

\bigskip
Equation \eqref{obj:SLP:maxDemands} expresses the maximization of the global demand.
Equation \eqref{constr:SLP:nbStations} bounds the total number of carsharing sites to $\nbMaxStations$.
Equations \eqref{constr:SLP:stationInnerFlow} and \eqref{constr:SLP:stationOuterFlow} limit the inner and outer flow in every arc.
Those two sets of constraints express the dependence between the state of the site (selected or not) and the possibility for vehicles to parked in the station.
Next, Equation \eqref{constr:SLP:nbJockeys} limits the maximum number of simultaneous vehicle relocation operations to $\nbMaxJockeys$.
As noted before, it can be viewed as the number of available jockeys operating each time the system is rebalancing.

\medskip
Equations \eqref{constr:SLP:nbVROs} to \eqref{constr:SLP:varFlows} are the same as those presented in the {\SDP} linear program.
They respectively limit the number of vehicle relocation operations and the total number of vehicles while the next two other are classical flow constraints.
Finally, Equations \eqref{constr:SLP:varFlows} and \eqref{constr:SLP:varStations} define the variables' domains.


\newpage
\section{Adding energy components} \label{sec:addingEnergy}
Throughout most of our discussion to this point, we have not talk about the vehicles themselves.
For the last decades, the rise of the number of vehicles on roads has grown to the point where traffic jams and pollution have become an issue.
In order to reduce dependence on oil, electric cars have retrieved a high interest since 2008 \cite{sperling_two_2009}.
This interest did not occurred just because of increasing oil prices but thanks as well to advances in batteries and energy management.
Climate policies and ecology have shifted consumer preferences.
The need to reduce greenhouse gas emissions seemed to be now a important concern for the car industry who  gave more and more attention to it in their products.
Today, more and more electric vehicles are used on the roads.
As of 2016, the market share in France represent almost 1\% \cite{VE_MarketShare2016}.

\medskip
The electric cars have several benefits over conventional internal combustion engine automobiles \cite{VE_avantages}.
First of all, they are cleaner vehicles.
Especially in cities, they help reducing significantly the air pollution.
They do not emit harmful tailpipe pollutants such as particulates (soot), volatile organic compounds, hydrocarbons, carbon monoxide, ozone, lead, and various oxides of nitrogen.
Depending on the nature and origin of the electricity, electric vehicles spend around 20g of CO2/km against almost 130g of CO2/km for combustion vehicles.
The gap in term of environmental cost between the electric and the fuel car will become even larger with the development and the availability of renewable energies.
Secondly, electric motors are more energy efficient.
No consumption is made during the off-idle phase and some energy can even be recover during deceleration or braking phases \cite{artmeier_optimal_2010}.
Finally, driving an electric vehicles appeared more reliable and pleasant.
People spend less time and money for repairs and vehicles are much more quieter than gasoline-powered cars.

\medskip
The major drawback of an electric vehicle comes from its battery.
More precisely, the distance it can travel without the necessity to recharge (also call the \emph{range} of the vehicle) do not exceed 160km for a standard car in urban traffic conditions, like a Renault Zoe for instance.
Thus, electric vehicles are not presently suited for long distances but are more appropriate for short travels in urban areas.
Additionally, charging a vehicle can take considerable time depending on the charging technique.
The time needed to recharge a battery entirely depends on the available power supply.
Basically, the more the power, the quicker the battery charged.
Four power tiers, expressed in kWatt (SI unit symbol: kW), are currently used in the market \cite{livre_vert_2014}: home charging (3kW), quick charging (22kW) and fast charging (44kW).
More recently, superchargers delivering up to 120kW are today available.
Those levels allow to charge a standard battery of 22kWh within respectively 6-8h, 1-2h and 20-30 minutes.
Home charging answers to the most common situations where the vehicle is parked during a long period, during the night or working time for instance.
Conversely, quick and fast charging require specific electric devices to be used and are not recommended for a day to day charge.
They are more suited when parking time is very limited.
They grant a higher flexibility covering situations with additional non-planned kilometres.

\subsection{Related work}

Introducing electric cars in station-based carsharing systems brings up new practical challenges with respect to their design and the management.
Actual battery range require the vehicles to charge during the day at specific charging points in stations.
Moreover, depending on the system infrastructure, the power supply may induce long charging times unless expensive fast charging points are provided.
In this section we give a brief overview of the emerging problems arising when electric vehicles are considered in carsharing context.
Although the existing literature is today very limited, we focus in this section on two problems: the energy shortest path problem and the carsharing system design including electric vehicles. 

% the management of the car battery and the impact on electric facilities.

\medskip
The energy shortest path problem consists in finding the least energy consuming path between two stations.
In order to maintain enough energy in vehicles and maintain their availability, the carsharing operator needs to estimate the energy consumption of each trip performed during the day.
Thereby, accurate information can be provided for users (through dedicated navigation services) and for jockeys rebalancing the fleet.
In earlier works, \cite{artmeier_optimal_2010} showed that the problem is a \emph{easier} variant of the constrained shortest path problem, known to be ${\cal NP}$-hard.
From this work, researchers tend to improve the problem complexity proposing more efficient algorithms and exploring other aspects and additional constraints \cite{eisner_optimal_2011, sachenbacher_efficient_2011}.

More recently, other approaches using MIP formulation \cite{touati_combinatorial_2012, wang_energy_2014, arslan_minimum_2015}.
Some models allow to consider multiple vehicles, involved traffic congestion and non-linear cost functions.
Finding accurate linear approximations for these functions is often highlighted as a valuable improvement in future works.


\medskip
Carsharing system design problem including electric vehicles is a very recent topic and very few studies try to integrate electric constraints in strategic planning decisions.
\cite{boyaci_optimization_2015} proposed a multi-objective MIP model for planning one-way vehicle-sharing systems.
Vehicle relocation operations and electric vehicle charging requirements are taking onto account.
However, the charge state of each vehicle's battery is not explicitly considered.
The authors include vehicles charging periods with specific constraints ensuring that a vehicle stays in stations for a fixed period of time when returned from a rental operation.
A real case application of their model for to Nice region (France) using data from an existing carsharing system provides useful information regarding the system performance.
The trade-off between operator and user objectives exhibit the importance of vehicle relocation benefiting to both stake holders.
The authors plan in a future work to couple their model with a simulation tool which providing more realistic representation of relocation operation costs and allow to consider vehicle charge level among the optimisation process.


\medskip
Beyond these results globally tackling many problems individually, no combined approaches has arise. 
As far as we know, optimizing the global system efficiency and the station locations while taking into account explicitly battery ranges and the power supply has not been addressed.
The large amount of open problems suggests that those topics may account in the near future for a rich and interesting  research area.


% Sean %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%there is no available model which takes all these problems into account at the moment.
%Trying to resolve them one by one will probably lead to an non optimal solution.
%As far as we know, there is only one paper which tries to make the connexions between these problems \cite{boyaci_optimization_2015}.
%The model considers that the client has to reserve his car in advance so it doesn't simulate the demand.
%Moreover, the model is too complex to be able to run in a reasonable time lapse.
%The authors then choose to relax the problem in order to be able to find a solution.
%They obtained a result with an error of 8\% in less than 3 hours in most of the instances.

%supporting strategic and tactical planning decisions for both .
%Few studies take into account the car battery and the charge time.
%They either block the cars that need to be charged at a station for a fixed period of time \cite{boyaci_optimization_2015} or add variables to represent the battery \cite{bruglieri_vehicle_2014}.
%Thus, research tends to maximize the remaining quantity of energy in the battery at the end of the day and only charge during the night.\\
%
%The impact on electric facilities is nearly null in the U.S. due to the policy on electricity which create oversize network \cite{liu_survey_2011}.
%However, this study shows the importance of taking the hour of demand into account in order to reduce the price of electricity. 
%The problem of redistribution for electric cars was studied with meta-heuristics or with MILP.
%Two approaches have been developed for this problem.
%The first one uses trucks to move the cars from one station to another.
%The second uses folding bicycles to travel between two stations and stock the bicycle in the car during the relocation trip \cite{bruglieri_vehicle_2014}.
%
%\medskip
%The sizing and localisation problems for electric carsharing systems were studied but most of the time, were not in relation with the relocation problem.
%In these articles, vehicle relocations are made by night.
%It increases the size of stations in order to accept the demands \cite{correia_optimization_2012}.
%However, this problem is also studied for bicycles \cite{george_fleet_2011} and hydrogen cars \cite{melaina_initiating_2003} and the methods used in these researches may be applied for the sizing and localisation problem.

%It also modifies three other problems: the dimensioning, the station location and the vehicle relocation for one-way carsharing.
%Some characteristics of electric cars were simplified in order to reduce the number of problems.
%For instance, the charging model is assumed to be linear.

%This problem arises with the energy recuperation during the deceleration phase.
%It has been studied using MILP \cite{touati_combinatorial_2012} and algorithms based on the shortest path principle on modified graph \cite{artmeier_optimal_2010}.\\


\subsection{Selected energy components and modelling issues}
Opt for electric vehicles bring some important constraints, on vehicles themselves of course but also on the system (stations especially) and its dynamics.
In this section we discuss some energetic components we thought essential or interesting to introduce in the optimization process.
Although not all of them were selected in the detailed model presented in the next section, we still wanted to give here some insights to be familiar with each of them.
Afterwards, some modelling issues are highlighted.

\subsubsection{The battery capacity}
Despite there exists a large diversity of electric batteries, the most common are based on the lithium ion technology.
Their light weight make them suitable for numerous applications such as portable devices, power tools or electric vehicles.
Today, the typical battery range for carsharing electric vehicles varies on average from 160 to 250 kilometres, depending on the driving context and the weather conditions.

\subsubsection{The power supply}
For now, charging an electric car takes from 30 minutes to 6 hours depending on the charging technology.
Moreover, the charge is not linear.
It is very fast during approximately the 80 first percents of the battery capacity and became more and more slower until reaching the full capacity.
But for reasons of simplicity, we will assume in this work that the battery charge follows a linear profile.

%This is due to the fact that the charger need to check the level of charge of each cell of the battery during the electric transfer.

\subsubsection{The discharge}
Modelling the discharge of an electric vehicle can be difficult because electric cars can restore some energy during decelerating and braking phases.
Additionally, note that the discharge when the vehicle is neither used or plug into a charging point is negligible, about 1 to 2\% per month.
In this work, we assume the battery discharge to be linear over time.

\subsubsection{The number of charging points per station}
Carsharing systems with electric vehicles have to equip their stations with charging points.
During the design phase of the system, it could be interesting not to consider systematically that all the parking spot are equipped with charging points. 
A better solution would be providing power supply where the system need to, according to the estimated stations' attractiveness.
Thereby, the operator save money while maintaining a good level of service.

%This allows us to see how the system reacts if all the parking spots don't have a charging borne;

\subsubsection{Price of electricity}
In France, the price of electricity constantly varies during the day.
It is fixed at the European Power Exchange SE (EPEX SPOT SE), the exchange operating the power spot market for short-term trading power in some European country, including France.
Integrate this price in a system design context could certainly be a interesting feature.
Fostering the recharge by night for instance, when the price of electricity is the lowest, could be a significant  economic argument.


\bigskip
Conclusion. What are the selected components?


\subsubsection{Modelling issues: the flow interpretation}
In a carsharing system with electric vehicles, accept or reject a request will not only depend on the vehicle availability.
The battery level become a important parameter impacting the decision to provide or not the resource, in this case the electric car.
It has to be sufficient enough at least to travel the distance between the origin and the destination.
Whether to fulfil a request, or operate a vehicle relocation operation, we now need to track and check every single vehicle in the system over time.
From a modelling point of view, we have seen previously that vehicles are considered as flows in a time expanded graph.
Since then, the flow was considered as integer but not necessary unitary.
This means that an optimal flow could admits some parts where more than a unit flow is passing through an arc.
From a system point of view, without the need to track single vehicles, it was not a problem and corresponded to merged vehicles itineraries.
However, in order to identify the route of each vehicle in the system, an interpretation of the flow as a set of unit flows has to be determine.

\begin{figure}[t]
\begin{center}
\input{tikz/flowInterpretation}
\end{center}
\caption{Different flow interpretations.}
\label{fig:flowInterpretation}
\end{figure}

\medskip
Figure \ref{fig:flowInterpretation} illustrates a unit flow interpretation even when the flow is unitary.
Suppose that an optimal flow admits a baseline situation as illustrated by the above graph of the figure.
This solution is feasible since the conservation flow is respected; the number of inner and outer flow is the same in each node.
Now the question is to recover from this situation vehicles' itineraries as unit flow paths starting and ending at time $t=1$.
Obviously, a first interpretation could lead to the left figure, where the two colors indicate the vehicles itineraries.
Another possible interpretation is presented in the right figure, where this time both vehicles do not end their trip in the station they came from.
Note that even if both cases are feasible solutions, they do not require the same amount of energy.
In the first case, the blue car will move two times, thus require more energy than the other vehicle which stays in station $1$.
In the other side, the situation is more equilibrated.
Both vehicles move exactly one time and share the energetic requirements.

\medskip
As illustrated by this example, we can enumerate two conclusions.
First, with a realistic size carsharing system, \ie with much more stations and numerous time-steps, a unique feasible solution could lead to many interpretations in terms of vehicles' itineraries.
Secondly, every interpretation has its own energetic impact and, besides could not be feasible in that sense. 

Therefore, introduce energy components through a feasible interpretation of vehicles' itineraries do not seem a relevant and reliable solution.
There is furthermore no guaranty that an optimal solution could be extracted from a solution that do not take into account the energy.
We finally decided to reuse the model previously used to solve the {\SLP} and adapt it so that it can support and include energy constraints.


\subsection{Mathematical program}
The major issue underlined in the previous section concerns the flow decomposition into unitary flow paths.
This decomposition is essential to follow every vehicle in the system and be able to track its batteries over time.
Indeed, with electric vehicles, their availability in a station at a given time is not sufficient to ensure the travel.
The battery level also take part in the decision process and assesses if the required travel could be support or not.
In this section, we present how to modify the previous time expanded graph so that it can support energy components.
A new mathematical model is finally presented.

\subsubsection{Graph transformations} \label{sec:graphTransformations}
Avoiding the flow interpretation can be simply achieve by duplicate arcs with non unitary bound.
The basic idea is to force the flow to be unitary by limiting the arcs' capacities.
In fact, the system remains unchanged if we replicate each arc $a \in \tegArcSet$ into $u(a)$ (the arc capacity) arcs with unitary capacities.
Figure \ref{fig:tegTransformation} illustrates the transformation.
The initial TEG introduced in Chapter \ref{chap:sdp} is transformed into a TEG where all the arcs are bounded by $1$.
Even the relocation arcs, where the capacities were previously set to infinity, can be unitary bounded.
Again, this could be done without loss of generality since it only limit a vehicle relocation operation to be operate by only one jockey, which is realistic.

\medskip
This simple transformation allows now the flow to be at most unitary.
Nevertheless, the operation can be achieve at the cost of a notable increase in the number of arcs.
More precisely, the only set of arc impacted is the set $\tegArcSet_1$ corresponding to the stock arcs.
For the record, their original number was about exactly $\nbStations \cdot \nbTimeSteps$ arcs.
Now, the size of the new set of stock arcs, noted $\tegArcSet_1'$ is exactly:
\begin{equation}
|\tegArcSet_1'| = \sum\limits_{i=1}^\nbStations (Z(i) \cdot \nbTimeSteps) = \nbTimeSteps \cdot \sum\limits_{i=1}^\nbStations Z(i)
\end{equation}

In practice, this means that the increasing factor depends on the maximum size of the carsharing stations, or sites.
It will be important to keep this result in mind since the number of variables depends directly on the number of arcs.

\begin{figure}[t]
\begin{center}
\scalebox{0.7}{\input{tikz/tegTransformation}}
\end{center}
\caption{TEG transformation to support energy components.}
\label{fig:tegTransformation}
\end{figure}

\subsubsection{Additional parameters}
To extend the model with electric components, let's first define some parameters related to batteries and stations' power supply.
All the other notations or variables have the same meaning that before.
For the record, $\Delta t$ is the time period expressed in minutes between two consecutive time-steps.

The total capacity of the vehicle battery will be noted $E$.
For sake of simplicity, this value will be expressed in kilometres but could equivalently be expressed in kiloWatts.
Indeed, it is assumed that the two units are link through a linear relation.
Besides, it is also assumed that all vehicles are equipped with the same type of batteries.

\medskip
As said before, there exists different types of station power supply.
Depending on the battery capacity, the power however can be expressed over time.
Let $\omega (E)$ be the number of minutes needed to refill an empty battery to full charge.

\medskip
Since the vehicles now consume energy when travelling and have the possibility to recover it when parked in station, some adjustments are required.
We associate with each arc $a \in \tegArcSet'$ in the new graph an additional value noted $\enCons$, standing for the energy consumption.
This value expressed in kilometres will be positive when vehicles performed a trip (\ie for demand arcs $\tegArcSet_2$ and vehicle relocation arcs $\tegArcSet_3$) and negative when parked in station (\ie stock arcs $\tegArcSet_1$).
The distance in kilometres between stations $s_1$ and $s_2$, both in the set $\stationSet$, is denoted by $d(s_1, s_2)$.
This value can be recovered from any mapping tool simulation giving exactly the distance between stations by road or it could more simply corresponds to the euclidean distance between them.
Nevertheless, a penalty coefficient $\rho \geq 1$ revised the value during rush-hours as vehicles consume more energy at lower speed travelling the same distance.
Outside these periods, we set $\rho = 1$.

\medskip
Therefore, the energy consumption is formally defined as:
\begin{numcases}{\enCons(a=(x, y)) =}
- \frac{E \cdot \Delta t}{\omega (E)} & if $a \in \tegArcSet_1$,\label{eq:consumtionStation}\\
\rho \cdot d(\eta(x), \eta(y)) & if $a \in \tegArcSet_2 \cup \tegArcSet_3$.\label{eq:consumtionTravel}
\end{numcases}

\medskip
First equation \eqref{eq:consumtionStation} assigns to every stock arc the number of kilometres a vehicle could travel if it recharge its battery during one time-steps; stock arcs connect nodes spaced from a single time-step interval.
Second equation \eqref{eq:consumtionTravel} stands for the travel distance between stations raised by the penalty coefficient during rush periods.

\subsubsection{Variables}
The set of variables is extended to three sets.
The first one remains the flow variables.
Assign to every arc of the graph, they identify as before vehicles' routes through the system.
Note however that now the flow do not longer need to be integer.
A boolean domain is sufficient since all the arc capacities were set to $1$.
Next set of variables aim at avoiding path interpretations after having run the optimization process.
In each node, a boolean variable $A_{ij}$ indicates if the flow coming from arc $i$ is continuing to arc $j$.
We refer to those variables as the \emph{flow affectation} variables.
As discussed later on, this set is probably the major drawback of this model due to the substantially augmentation of the number of variables.
Their number however grows polynomially with respect to the number of arcs.
Lastly, let $E_a$ the \emph{battery level} of the flow (vehicle) entering the arc $a$.
Similarly to the energy consumption, those variables are expressed in kilometres.

\medskip
The three sets of variables are summarized in the following:
\begin{enumerate}
\item $\forall a \in \tegArcSet$,
\begin{numcases}{ ~~~~~~\varphi(a) =}
1 & if a flow enters arc $a$,\\
0 & if otherwise.
\end{numcases}

\item $\forall x \in \tegNodeSet$ such that $ i \in \Gamma^-(x)$ and $j \in \Gamma^+(x)$,
\begin{numcases}{ ~~~~~~A_{ij} =}
1 & if the flow coming from arc $i$ follows to arc $j$,\\
0 & if otherwise.
\end{numcases}

\item $\forall a \in \tegArcSet$, $E_a \in (0, E)$.
\end{enumerate}

Obviously, the total number of variables is much more greater than before.
Although flow variables and battery variables follow the number of arcs in the graph, this is not the case for the flow affectation variables.
%Indeed, their number grows polynomially with respect to the number of arcs.
At each node $x \in \tegNodeSet$ there is exactly $|\Gamma^-(x)| \cdot |\Gamma^+(x)|$ affectation variables that indicate the arc sequence in this specific node $x$.
Since $|\tegArcSet_1| \gg |\tegArcSet_2 \cup \tegArcSet_3|$ with the TEG transformation, their number can be approximated to
\begin{equation*}
\nbTimeSteps \cdot \sum\limits_{i=1}^\nbStations Z_i^2 = \Theta(|\tegArcSet|^2).
\end{equation*}

\subsubsection{Mathematical program}
Using the notations above, we can formulate the energy model as follows:

\begin{equation}\label{obj:ENERGY:maxDemands}
\text{[ENERGY]:} \max ~~\sum\limits_{a \in \tegArcSet_2}  \varphi (a)
\end{equation}
\begin{numcases}{s.t.}
E_j \leq E_i - \enCons(i) \cdot A_{ij} + E \cdot (1 - A_{ij}) & $\forall (i,j) \in \tegArcSet^2$ \label{constr:ENERGY:a}\\
E_i \leq E_j + E *(1 - A_{ij}) & $\forall (i, j) \in \tegArcSet_1 \times \tegArcSet$ \label{constr:ENERGY:b}\\
\varphi(a) \cdot \enCons(a) \leq E_a & $\forall a \in \tegArcSet_2 \cup \tegArcSet_3$ \label{constr:ENERGY:c}\\
E_a \leq E \cdot \varphi(a) & $\forall a \in \tegArcSet$ \label{constr:ENERGY:d}\\
\sum_j A_{kj} = \varphi(k) & $\forall k \in \tegArcSet$ \label{constr:ENERGY:flowCons:a}\\
\sum_k A_{kj} = \varphi(j) & $\forall j \in \tegArcSet$ \label{constr:ENERGY:flowCons:b}\\
%
% nb relocs & nb vehicles
\sum_{a \in \tegArcSet_3} \varphi(a) \leq \nbVROs \label{constr:ENERGY:nbVROs}\\
\sum_{a\in \tegArcSet} \varphi(a) \cdot \epsilon_a \leq \nbVehicles \label{constr:ENERGY:nbVehicles}\\
%
% jockey constr
\sum_{a \in \tegArcSet_3^t} \varphi(a) \leq \nbMaxJockeys & $\forall t \in \relocTimeStepSet$ \label{constr:ENERGY:nbJockeys}\\
%
% station constr
\sum_{i=1}^\nbStations b_i \leq \nbMaxStations \label{constr:ENERGY:nbStations}\\
\varphi(a) \leq b_{\eta(x)} \cdot \tegCapacity(a) &$\forall a = (x, y) \in \tegArcSet$ \label{constr:ENERGY:stationInnerFlow} \\
\varphi(a) \leq b_{\eta(y)} \cdot \tegCapacity(a) &$\forall a = (x, y) \in \tegArcSet_2 \cap \tegArcSet_3$ \label{constr:ENERGY:stationOuterFlow}\\
%
% variables
E_a \in (0, E) & $\forall a \in \tegArcSet$ \label{constr:ENERGY:varBatteries}\\
A_{ij} \in \{0,1\} & $\forall (i,j) \in \tegArcSet^2$ \label{constr:ENERGY:varAij}\\
\varphi(a) \in \{0,1\} & $\forall a \in \tegArcSet$ \label{constr:ENERGY:varFlows}\\
b_i \in \{0, 1\} & $\forall i \in \{1, \dots, \nbStations\}$ \label{constr:ENERGY:varStations}\\
\end{numcases}

\bigskip
As always, the objective function \eqref{obj:ENERGY:maxDemands} maximizes the number of satisfied demands.
The first six groups of constraints are related to the energy components and the flow affectation variables.
Equation \eqref{constr:ENERGY:a} defines the upper bound of the battery level.
If the flow coming from arc $i$ is continuing its path to arc $j$ (\ie if $A_{ij} = 1$), then the battery level $E_j$ is at most the previous battery level $E_i$ minus the energy consumption when passing thought arc $i$ (\ie $\enCons(i)$).
In the case of $A_{ij} = 0$, there is no need to limit $E_j$ and its upper bound is relaxed to $E_i + E$, a greater value than the battery capacity.
%
Next constraints \eqref{constr:ENERGY:b} ensures that the battery do not discharge when parked in station.
After being parked in station, the battery level of each vehicle must at least equals to its value before the operation.
This situation is expressed as $E_i \leq E_j$ when $A_{ij} = 1$ and $i \in \tegArcSet_1$.
%
Equation \eqref{constr:ENERGY:c} connects the battery level and the energy consumption when vehicles are travelling.
It requires the battery to dispose of a sufficient level in order to achieve the trip, whether it is a demand or a vehicle relocation.
%
Constraints \eqref{constr:ENERGY:d} set the battery level variables to $0$ if there is no vehicle passing through the arc $a$.
%
Finally, constraints \eqref{constr:ENERGY:flowCons:a} and \eqref{constr:ENERGY:flowCons:b} are flow conservation constraints.
As illustrated in Figure \ref{fig:flowConservation}, it ensures that no more than one unit of flow is coming from the predecessors of node $x$.
Similarly, at most one unit of flow can continue to the successor of node $y$ after passing through the arc $j$.

\begin{figure}[t]
\begin{center}
\scalebox{1}{\input{tikz/flowConservation}}
\end{center}
\caption{Flow conservation.}
\label{fig:flowConservation}
\end{figure}

\medskip
Next equations are the same as in the station location model.
For the record, note that $\nbVROs$, $\nbVehicles$, $\nbMaxJockeys$ and $\nbMaxStations$ denote respectively for the maximum number of relocation operations, vehicles, jockeys and opened carsharing sites.
Equations \eqref{constr:ENERGY:stationInnerFlow} and \eqref{constr:ENERGY:stationOuterFlow} forbid the inner and outer flow coming or leaving not selected sites.
%
Finally, Equations \eqref{constr:ENERGY:varBatteries} to \eqref{constr:ENERGY:varStations} express the respective variable domains.

\section{Discussions and improvements}
\subsection{Model statements}

The model {\ENERGY} allows us to tackle the station location problem while taking into account energy components including the stations' power supply and vehicles' batteries.
Moreover, vehicles' routes do not longer have to be deduced or calculated from an optimal flow solution.
Following successive non-zero values of flow affectation variables (\ie $A_{ij}, A_{jk} \dots$) allow to constitute vehicle itineraries and avoid routes interpretation.
Besides, any feasible solution provides the energy consumption profile of all vehicles by simply reporting every battery variable value along vehicle itineraries.
As a results, this model seams promising.
Unfortunately, the number of variables, directly related to the total number of arcs, has increased dramatically.
More importantly, the number of arcs has already grown compared to the previous model (\see Section \ref{sec:graphTransformations}, page \pageref{sec:graphTransformations} about the graph transformations).
We present in the following some solutions to reduce the number of variables and improve the model sustainability.

%\item Modify Cplex parameters;
%\item Break the symmetry;
%\item Give to Cplex a solution to start.

%\begin{itemize}
%\item \emph{VarSel}:
%the strategy choose the next branch that Cplex is going to explore.
%In our solution, Cplex stays a long time on a branching node before opening a branch.
%It reduces the time spent on each branch and reduce also the memory use.
%\item \emph{RINSHeur}:
%decides how often to apply the relaxation induced neighborhood search (RINS) heuristic.
%It helps Cplex to quickly find a possible solution;
%We also use different cuts to to accelerate the research, as for instance Gomory's cut.
%\end{itemize}

\subsection{Removing the symmetries}
One of the main drawback leading to the surge of the number of variables is the \emph{arc symmetries}.
By duplicating the stock arcs during the graph transformation phase, we created multiple equivalent situations.
Indeed, the number of flow affectation variables depends on the number of inner and outer arcs in each node of the TEG.
In practice, it is not necessary to create a flow affectation variable to each pairs of successive stock arcs.
Perhaps the best way to understand the possible reduction is via an example.

\begin{figure}[t]
\begin{center}
\scalebox{1}{\input{tikz/symmetryExample}}
\end{center}
\caption{A case of symmetry.}
\label{fig:symmetryExample}
\end{figure}

\medskip
Let consider the situation depicted in Figure \ref{fig:symmetryExample}, where it is assumed that the arcs belong to the set of stock arcs ($\tegArcSet_1$).
Three time-consecutive nodes are represented.
The station they symbolized have a maximum capacity of two parking lots, thus nodes are link by a pair of arcs; \eg $a$ and $c$ between nodes $x$ and $y$.
Until then, four flow affectation variables were considered: $A_{ab}$, $A_{ad}$, $A_{cb}$, $A_{cd}$.
Those situations are depicted on the left side of the Figure.
From a system point of view, a unit-flow leaving $x$, then entering $y$ to finally arrive at node $z$ means that a single vehicle is parked in the station during two time-steps.
In this case, one of the flow affectation variable enumerated above is set to $1$.
However, there is no difference in term of interpretation for a unit-flow entering node $y$ whether continuing through arc $b$ or continuing through arc $d$.
In a certain way it can be viewed as a ``parking slot swap''.
It is as if the vehicle parked in slot $1$ need to change to slot $2$.
This distinction might be interesting if we had included the possibility to stations not to have all their parking slots equipped with power supply points.
But so far, this possibility has not been assumed in the model.

\medskip
As a consequence, the number of flow affectation variables can be highly reduced.
Distinctive pairs of successive arcs are sufficient to cover realistic situations without reducing the possibilities.
Following this idea, the number of flow affectation variables related to stock arcs decreases from $|\Gamma^-(x) \cap \tegArcSet_1|\cdot|\Gamma^+(x) \cap \tegArcSet_1| = Z(\eta(x))^2$ to $Z(\eta(x))$ for all $x \in \tegNodeSet$.

%\begin{figure}[t]
%\begin{center}
%\scalebox{1}{\input{tikz/variableReduction}}
%\end{center}
%\caption{Variable reduction.}
%\label{fig:variableReduction}
%\end{figure}

\subsection{A greedy heuristic}

Running the {\ENERGY} model induce limitations due to computation time and solver capability.
In practice, even on small instances ($20$ stations, 15-minute time-steps and $600$ daily requests), CPLEX encounters great difficulties to converge.
The relaxed problem resolution is solved relatively quickly (within minutes) but fail most of the time at founding a good quality lower integer bound.
To deal with this issue, we investigated an approaches based on the \emph{warm start} technique.
The idea is to provide the solver a solution before starting the MIP optimization.
The solution may be incomplete and, basically it consists in defining value assignments for a set of variables (discrete and/or continuous).

\medskip
Because we do not have observed so far a noteworthy pattern in the solutions, it seams difficult a priori to come up with a rounded solution.
We denote by \emph{rounded solution} a set of variables' values coming from the optimization of a relaxed instance of the problem and then rounded following more or less sophisticated rules.
In our experimentations, we only used binary rules.
For instance, suppose a binary variable $x$.
For an observed non-integer optimum value $x^\star$, its rounded value is set to $\lfloor x^\star \rfloor$ if $x^\star \leq v \in (0, 1)$ and $\lceil x^\star \rceil$ otherwise.

Unfortunately, neither the vehicles' trip profiles or the station attendances showed notable patterns what could help us defining that could be a good quality solution.
Although we tested numerous rounding configurations, we have not succeeded in decreasing solver computation times using rounded solutions.

\medskip
To cope with solving times, we finally opted for a greedy heuristic implementation.
Unlike the previous solution, an heuristic benefits from a fast execution and come up with a feasible solution satisfying energy constraints.
The next of the section describes the mechanics of the algorithm.
A simple example running the some steps of the heuristic is finally presented.


\subsubsection{Functional description}
The main idea is to build vehicles' routes from a weight modified TEG while taking into account the energy viability of vehicles' itineraries.
Since the {\ENERGY} problem aims at maximize the number of satisfied demands, the heuristic is based on a modified Dijkstra's algorithm \cite{dijkstra_1959} where the weights on the arcs are set as followed:
\begin{numcases}{w(a)=}
0 & if $a \in \tegArcSet_2$, \nonumber\\
1 & otherwise. \nonumber
\end{numcases}

Equivalently, we refer to $w_{ij}$ as the weight value between nodes $i$ and $j$, \ie $w_{ij} = w(a)$ for any $a = (i, j) \in \tegArcSet$.
As a consequence, arcs are weighted according to their contribution to the objective function.
By doing so, find the path with the highest number of demands arcs linking two nodes in the TEG is equivalent to find the shortest path therebetween.
To deal with this shortest path problem, we have opted to use the Dijkstra's algorithm, a label-setting algorithm returning a solution in a polynomial time.
However, the path may not be feasible according to energy constraints and some algorithmic adjustments are needed.
It should be noted here that we actually are looking for shortest \emph{cycles}, due to the Theorem \ref{th:decomp} (page \pageref{th:decomp}).


\medskip
In addition to the standard distance label value $d(i)$, we associate to each node $i$ an energy label $e(i)$ standing for the vehicle battery level at this node, which is an lower bound of the energy remaining in the battery for this specific node.
At each iteration, and similarly to the distance label, the energy label will be updated according to the energy consumption it takes to reach adjacent nodes.
Any adjacent nodes $j$ for which $e(i)- w_{ij} < 0$ can not pretend being a feasible successor of node $i$.
As a consequence, neither its distance label nor energy label should be updated.
At any intermediate step of the algorithm, the energy label of a node $i$ stores the maximum battery level of a vehicle performing the shortest energetically viable path from the source.
It is assumed that the vehicle recharged its battery when parked in station whenever it is possible.

\medskip
The algorithm iterates over a set of starting nodes defined as $\tegNodeSet_t = \{x \in \tegNodeSet \mid \theta (x) = t\}$.
This set represents a temporal snapshot of the system at a given time-step $t \in \timeStepSet$.
In practice, we usually use $\tegNodeSet_1$ and the algorithm tries to find as many cycles as possible from this set.
The algorithm terminates when no more cycle containing demand arcs can be found.
It should be noted that the problem we address here is not to find shorter paths from a source to every other nodes in the network but rather to find shortest cycles, which can be viewed as paths starting and ending at the same vertex.
To solve the problem faster, the algorithm terminates the cycle search procedure as soon as the source can pretend to be selected from the list of temporary labelled nodes, even though some nodes are still in this list.

\medskip
Algorithm \ref{algo:dijEnergy} gives a formal algorithmic description of the modified Dijkstra's algorithm taking into account energy constraints.

\begin{algorithm}[h]
%\DontPrintSemicolon % Some LaTeX compilers require you to use \dontprintsemicolon instead
\BlankLine
\KwIn{
$\teg = (\tegNodeSet, \tegArcSet, e)$, a binary weighted TEG where weights are set to 0 on demands arcs and 1 elsewhere;
$t \in \timeStepSet$ defining $\tegNodeSet_t = \{x \in \tegNodeSet \mid \theta (x) = t\}$, a set of departure nodes.
}
\KwOut{$C$: a set of vehicles' routes verifying energy constraints.}

\BlankLine
$C \leftarrow \emptyset$\;
\While{$\tegNodeSet_t \not= \emptyset$}{
	\medskip
	\tcp{Initialisation}
	pick $s \in \tegNodeSet_t$\;
	$S \leftarrow \emptyset$ and $\bar{S} \leftarrow \tegNodeSet$\;
	$d(x) \leftarrow +\infty$ and $e(x) \leftarrow -\infty$, for each node $ x \in \bar{S}$\;
	\ForEach{$j \in \Gamma^+(s)$}{
		$d(j) \leftarrow w_{sj}$\;
		$e(j) \leftarrow \max\{E, e(s) - \gamma_{sj}\}$\;
		$pred(j) \leftarrow s$\;
	}
		
	\medskip
	\tcp{Cycle search routine}
	\While{$\bar{S} \neq \emptyset$ {\bf and} $d(s) \not= \min\{d_j : j \in \bar{S}\}$}{
		let $i \in \bar{S}$ be the node for which $d(i) = \min\{d_j : j \in \bar{S}\}$\;
		$S \leftarrow S \cup \{i\}$\;
		$\bar{S} \leftarrow \bar{S} - \{i\}$\;
		
		\medskip
		\ForEach{$j \in \Gamma^+(i)$}{
			\If{$d(j) > d(i) + w_{ij}$ {\bf and} $e(j) < \max\{E, e(i) - \gamma_{ij}\}$}{
				\medskip
				\tcp{update distance and energy}				
				$d(j) \leftarrow d(i) + w_{ij}$\;
				$e(j) \leftarrow \max\{E, e(i) - \gamma_{ij}\}$\;
				$pred(j) \leftarrow i$\;
			}
		}
	}
	
	\medskip
	\tcp{Recover the cycle and update sets before iterate}
	$cycle(s) \leftarrow $ the shortest cycle given by the directed out-tree\; % maintained with pred(i) $\forall i \in \tegNodeSet$\;
	\If{$\tegArcSet_2 \cap cycle(s) \not= \emptyset$ {\bf and} $e(s)\geq 0$}{
		$\tegArcSet \leftarrow \tegArcSet - \{cycle(s)\}$\;
		$C \leftarrow C \cup cycle(s)$\;
		}
	$\tegNodeSet_t \leftarrow \tegNodeSet_t - \{s\}$\;	
}

\caption{Modified Dijkstra's algorithm;}
\label{algo:dijEnergy}
\end{algorithm}

We illustrate the mechanics of the algorithm \ref{algo:dijEnergy} using the numerical example given in Figure \ref{fig:heuristicExample}.
We consider the node $1$ as the source node and a maximum battery capacity of $10$ kilometres is assumed (\ie $E = 10$).
The above right figure depicts the graph topology as well as weights and energy consumption values in each arc.

\medskip
Figure \ref{fig:heuristicExample}(a) initialize the successors' labels of the source node.
Then, the algorithm permanently labels the nodes $3$, $5$, $6$ and $2$ in this given sequence.
Figure \ref{fig:heuristicExample}(b) to (e) illustrate the operations for some of these iterations.
Note in Figure \ref{fig:heuristicExample}(b) that $d(4)$ and $e(4)$ has not been updated.
Since the remaining energy at node $3$ was not sufficient for the trip requirements ($e(3) = 3 < \gamma_{34} = 5$), the path is not energetically viable in practice.

\medskip
Finally, in Figure \ref{fig:heuristicExample}(f), nodes $1$, $4$ and $7$ are equivalent choices since they all admit a distance label $d(i) = 2$.
Because the source node (node $1$) can now pretend to be permanently labeled, the cycle search routine ends in this iteration.
As a result, the shortest cycle is $(1, 3, 5, 6, 1)$ and two demands are satisfied.
Note that energy constraints are satisfied since the energy label of node source is positive ($e(1) = 5$).

\begin{figure}[t]
\centering
\scalebox{.9}{\input{tikz/heuristicExample}}
\caption{Illustrating the modified Dijkstra's algorithm considering energy constraints.}
\label{fig:heuristicExample}
\end{figure}

\newpage
\section{Conclusion}
In this chapter, we introduced several mathematical model for solving the station location problem.
This problem deals with the optimal selection of a sub-set of potential carsharing sites which maximize the global demand.
A first model {\SLP} relies on an enhanced version of the system dimensioning model {\SDP} exposed in Chapter \ref{chap:sdp} and combines diverse additional features.
In particular, the model limits the total number of \emph{jockeys} (employees in charge of the vehicle relocation operations) restraining the number of simultaneous vehicle relocation operations.
We highlighted the dependence between both models exhibiting a master-slave scheme.
Finally, a detailed {\SDP} generalised version of the {\SLP} model was presented.

\medskip
The second part of the chapter coped with the energy integration.
In practice, electric vehicles bring many specific attributes involved in the design of a carsharing system.
Among them, we have elected two major components: the battery range and the power supply of the charging points.
The first limits the total distance a vehicle can travel without recharging while the second defines the electric rate of charge the power supply delivers.
The main issue at including those parameters concerns the necessity to track every single vehicles during the period so that a trip can be rejected if the battery level is not sufficient.
We have shown that the previous model {\SLP} was not suitable at following vehicles.
More particularly, the transition from a flow-based solution to single vehicle routes cannot be achieve without an interpretation of the flow.
Besides, this interpretation leading to many vehicle routes configurations has no guaranty that a energetically feasible solution can be found.
As a consequence, an updated model was required.

\medskip
We finally introduced the model {\ENERGY}.
Based on unit-flows, the model avoids vehicle routes interpretation including \emph{rooting variables} (called affectation variables) at each nodes in a modified TEG.
Although vehicle routes can now be extracted very quickly, their integration in the model has lead to drastically increase the number of variables.
We thus provided a new set of variables exhibiting some symmetry configurations in the graph and decreasing their number from $\Theta (\nbTimeSteps \cdot \sum\limits_{i \in \stationSet} Z(i)^2)$ to $\Theta (\nbTimeSteps \cdot \sum\limits_{i \in \stationSet} Z(i))$.

\medskip
The chapter concludes with the description of a greedy heuristic, based on a modified Dijkstra's algorithm including energy components.
Some limitations due to computation time and solver (CPLEX) capability pointed out the necessity to provide a feasible solution before staring the optimization.
The algorithm adapts the label-setting algorithm so that the problem become a shorter path problem.
The main idea is to determine feasible vehicle routes providing boolean weights on arcs so that null values are assigned to arcs contributing to the objective function.
Adjustments on specific added labels aim to converge to a shorter path verifying energy constraints.
A formal description of the algorithm as well as a detailed example are provided.


%\subsection{Results}
%In conclusion, we have developed a model to solve the localisation and dimensioning problem with electric constraints.
%We also produced a state of the art on this problem.
%However, due to the complexity of this problem, Cplex was not able to solve it in a reasonable time on instances containing more than $10$ stations.
%To cope with that, we improved the model by breaking symmetries.
%We also developed an rounding technique and an heuristic.
%However the rounding technique didn't give any results.
%We were able to see the impacts of electric constraints in such problem. We saw that the electric constraints have an impact on the solution.
%However, we need to try in a system with more constraints to be able to see the impact.
%
%\subsection{Further research}
%There are several possible ways to pursuit and improve the resolution of this problem.
%One way would be to modify the model to take into account the possible path instead of arcs as variables and run a column generation method with a branch and price.
%Another solution would be to improve the heuristic by using a meta heuristic.
%Further research can also focus on the impact of electricity in system with a lower ratio vehicle/request.

\newpage
\addcontentsline{toc}{section}{Bibliography of chapter \thechapter}
\renewcommand{\bibname}{Bibliography of chapter \thechapter}
\putbib[bib/biblio]
\end{bibunit}
