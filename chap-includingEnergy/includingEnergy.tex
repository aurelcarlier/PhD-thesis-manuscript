\chapter{Including energy components} \label{chap:energy}
\begin{bibunit}[ieeetr]
\minitoc
\vspace{2cm}

\begin{minipage}[c]{.3\linewidth}
\includegraphics[width=\textwidth]{electricity}
\end{minipage}
\hfill
\begin{minipage}[c]{.7\linewidth}
\begin{abstract}
blabla\\
blabla\\
blabla\\
blabla\\
blabla\\
\end{abstract}
\end{minipage}

\newpage
\section{Problematic}
Personal cars are now part of most people lives.
They are very useful to move from point A to point B.
For the last decades, the number of vehicles has increased from 582 million in 1990 to 1,114 billions in 2012 (+91\% in twenty two years) [noRef].
This is due to the fact that more and more people have gained access to these cars and want to be able to move freely, without the restriction of public transportation.
However, the number of cars has grown to the point where traffic jams and pollution have become an issue.\\

The solutions to these issues are known.
For instance: electric or hydrogen driving vehicle are a possible solution for the pollution issue whereas carsharing and public transportation help to reduce the number of vehicles on the road and therefore the traffic jams.
Today, these alternatives to the standard fuel car are already used or in development.
But, even if each of these solutions have some advantages, they all have their own drawbacks.
For instance, hydrogen driving car has security defaults due to the storage of hydrogen.
This explains the fact that this car is not on the market.
Whereas electric cars are already on sale, they have a restrained number of kilometres due to the battery range (around 160 km) and cannot be charged in less than an hour for most of them.

\section{Intership objectives}
Aur√©lien Carlier, who is a PhD student at IRT SystemX, studied the following subject about carsharing: we suppose to be an operator who wants to create a carsharing system in a city.
We have a set of possible spots to build our carsharing station with a maximum number of parking spots.
Then, we have two main problematics:
\begin{itemize}
\item \emph{Localisation :} we want to know which spot we are going to use.
\item \emph{Dimensioning :} we want to determine the number of parking spots of each selected station, the number of cars in the system and for each of them, their movement during the day. 
\end{itemize}

And we have four objectives: maximizing the number of requests the system is able to handle while minimizing the number of cars, vehicle relocations and stations needed.
In this problem, we suppose that all the requests and the time of each travel are known in advance.
This is not a small hypothesis but it can be made because one of the main objective of the MIC project is to be able to predict the requests and the travel time between two places. 

The aim of this intership is to propose model modification or a new model if necessary that include electric cars taking into account its components and constraints.
This new model will be used to see if these modifications have a real impact on the solution. 
To deal with it, the internship was divided into three main parts:
\begin{itemize}
\item The first part was to write a state of the art about this topic to know where the research were on this subject;
\item The second part was to understand the model already in place and see how to add the energy components; 
\item The last part was to add new parameters to the new model and accelerate the processing time.
\end{itemize}

\section{Related work}
A mettre dans l'intro carsharing !

\subsection{Definition, advantages and drawbacks}
Today, it continues to grow in major cities and tries to conquer middle sized cities.
In 2014, carsharing had 4.94 million members and 92 200 cars \cite{frost_strategic_2014}.
We can explain this will to make carsharing succeed by three facts.
Firstly, carsharing vehicle spend more time on the road in order to fulfil other requests so require fewer parking spaces \cite{mitchell_reinventing_2010} than personal car which spends 90\% of its time parked \cite{hu_summary_2004}.
Secondly, research \cite{sioui_carsharing_2013} proves that carsharing tends to reduce the average time spent driving.
And finally, carsharing has also positive impacts on the environment.

\subsection{Demand modelling}
Carsharing users have been studied and more precisely their motivations to use it.
Studies show that the average user is a 35 to 45 male, highly educated and environmentally aware.
Main factors to join a carsharing program are: the accessibility to the stations, the nearest station, the age of the station and the percentage of people using their personal car \cite{jorge_carsharing_2013}.
All these factors have to be taken into account for the development of carsharing.
One other main factor is the flexibility.
Due to its nature, round-way carsharing is unsuitable for capturing all possible trips.
So cars from round-way carsharing are mainly used for leisure or shopping \cite{barth_shared_use_2002, costain_synopsis_2012}.
One-way carsharing provide more freedom to the user which is a main selling point.
Today, the number of people giving up using their personal car and opting for carsharing is still unknown.
This number will be the key to finding out if carsharing really brings down the number of personal cars or if it attracts more people from the public transportation.
 
\subsection{Optimisation problems for one-way carsharing}
One-way carsharing allows to study various problems.
The first one is the number, the position and the size of the stations.
The sizing and station location problems were studied using MILP model \cite{rickenberg_decision_2013}.
However, the main issue with carsharing optimisation is the vehicle relocation.
Indeed, in the case of one-way carsharing, the user doesn't have to leave the car where it was  picked up.
This can create uneven distribution of cars depending on the trip which can lead to stations without cars or stations without free parking spaces.

This issue is more and more studied and research tends to lead to two possibilities.
The first one is to let the operator even out by relocating cars from stations with higher numbers of vehicles to stations with fewer number of vehicles.
This possibility is studied most of the time using stochastic method \cite{fan_optimizing_2014} or heuristics \cite{duron_analysis_2000}.
The second one is to reward the user by applying various incentive mechanisms.
For example, the operator decreases the rental cost if the client accepts to deliver his car not to the original station but to an almost empty station nearby.
This also means asking a group to use different cars if the station has not enough available parking spaces or asking strangers to regroup in order to use only one car if the station has less cars with a lower rental cost as reward.
This method has good results with preselected people but depends on the behaviour of the users.
Thus, in general, the client will choose his safety and privacy over a reward.

\subsection{The electric car}
The first electric car was made in 1880.
However, due to the mass production of cheap fuel cars and the evolution of combustion engines, the public lost interest in the electric car in the early 20th century.
Nowadays, with the rise of the fuel costs and the environmental issues, the electric car regained public interest and in 2008, it became more accessible to the public thanks to the development of battery and energy management techniques. 
In 2013, it represented 0.49\% market share in France and 0.63\% in the U.S [noRef].  
The electric car has one main advantage: it is cleaner than the fuel driven car.
Even if all the electricity was created by burning coal, it would have the same impact on the environment as the fuel car.
The gap in term of environmental cost between the electric car and the fuel car will become larger with the development of renewable energies to produce electricity.
However, it has two drawbacks.
The current battery can only travel 160 km on average [noRef] and charging a car can take a lot of time depending on the charging technique.
Currently, they are three ways to charge an electric car \cite{livre_vert_ministere}:
\begin{itemize}
\item Home charging: 8 to 10h;
\item Fast charging: 1 to  2h;
\item Ultra fast charging: 20 to 30 minutes.
\end{itemize}
Fast charging and ultra fast charging require specific electric devices to be used.
Also, ultra fast charging is not recommended for a day to day charge.
However, ongoing research try to improve vehicle range with a better battery durability and to develop new ways of charging.
One result of these researches is already used in the electric car and allows up to 20\% of energy recuperation during deceleration phase \cite{artmeier_optimal_2010}.

\subsection{Modelling with the electrical constraints}
Considering carsharing with the electric car brings up three problems: the energy shortest path problem, the management of the car battery and the impact on electric facilities.
It also modifies three other problems: the dimensioning, the station location and the vehicle relocation for one-way carsharing.
Some characteristics of electric cars were simplified in order to reduce the number of problems.
For instance, the charging model is assumed to be linear.

The energy shortest path problem consists in finding the least energy consuming path between two stations.
This problem arises with the energy recuperation during the deceleration phase.
It has been studied using MILP \cite{touati_combinatorial_2012} and algorithms based on the shortest path principle on modified graph \cite{artmeier_optimal_2010}.\\
Few studies take into account the car battery and the charge time.
They either block the cars that need to be charged at a station for a fixed period of time \cite{boyaci_optimization_2015} or add variables to represent the battery \cite{bruglieri_vehicle_2014}.
Thus, research tends to maximize the remaining quantity of energy in the battery at the end of the day and only charge during the night.\\
The impact on electric facilities is nearly null in the U.S. due to the policy on electricity which create oversize network\cite{liu_survey_2011}.
However, this study shows the importance of taking the hour of demand into account in order to reduce the price of electricity. 
The problem of redistribution for electric cars was studied with meta-heuristics or with MILP.
Two approaches have been developed for this problem.
The first one uses trucks to move the cars from one station to another.
The second uses folding bicycles to travel between two stations and stock the bicycle in the car during the relocation trip \cite{bruglieri_vehicle_2014}.

The sizing and localisation problems for electric carsharing systems were studied but most of the time, were not in relation with the relocation problem.
In these articles, vehicle relocations are made by night.
It increases the size of stations in order to accept the demands \cite{correia_optimization_2012}.
However, this problem is also studied for bicycles \cite{george_fleet_2011} and hydrogen cars \cite{melaina_initiating_2003} and the methods used in these researches may be applied for the sizing and localisation problem.

Despite these researches, there is no model  which takes all these problems into account at the moment.
Trying to resolve them one by one will probably lead to an non optimal solution.
As far as we know, there is only one paper which tries to make the connexions between these problems \cite{boyaci_optimization_2015}.
The model considers that the client has to reserve his car in advance so it doesn't simulate the demand.
Moreover, the model is too complex to be able to run in a reasonable time lapse.
The authors then choose to relax the problem in order to be able to find a solution.
They obtained a result with an error of 8\% in less than 3 hours in most of the instances.

\newpage
\section{Energy components and model}
One objective was to determine the impact of energy on the model and which parameter will be taken into account.
We found several parameters:

\begin{itemize}
\item
The battery capacity: if we want to use an electric car, the main parameter is the battery capacity.
Today, battery range allows an electric vehicle to travel on average 160 to 200 Km.
We suppose that our cars can travel 160 Km and this option can be modified if needed;

\item
The charge: at the moment, charging an electric car takes from 30 minutes to 6 hours depending on the charging technology.
We suppose that our cars charge in 6 hours but it can be modified if needed.
Moreover, the charge is not linear.
This is due to the fact that the charger need to check the level of charge of each cell of the battery during the electric transfer.
In our model, we suppose that the charging is a linear function;

\item
The discharge: modelling the  discharge of an electric vehicle can be difficult because electric cars can restore some energy when decelerating.
So in our case, we suppose that the discharge is linear but more important if there is a traffic jam.
We also suppose that the car didn't discharge when parked in station;

\item
The number of charge per station is also a parameter.
This allows us to see how the system reacts if all the parking spots don't have a charging borne;

\item
Price of electricity: it varies during the day so it could be a good choice to try to minimize the electric cost and to see what is the impact of the carsharing system on the electric system.
Unfortunately, this option was not taken into account.
\end{itemize}
 
In order to include all these parameters, we tried to find an option which can be used.\\
\textbf{Option 1} can be explained as follows: 
\begin{enumerate}
\item
Solve the problem without the energy constraints;
\item
Get from Cplex a pool of optimal solution;
\item
Try to add energy constraints. If this succeeds, then we have our solution;
\item
If this doesn't succeed, try with an heuristic to repair the solution.
\end{enumerate}
This method was not pursued because trying to repair a flow with an heuristic may not return a result and doesn't give any guarantee for the optimality of the solution if it gives a result.\\
\textbf{Option 2} was to use path instead of flow.
The main problem with the flow was to reconstruct the path used by the car to verify if the travel was feasible.
Indeed, we can see an example of this in the following graph \textbf{Figure  4.2}.
We can see that we the travel of two cars which start and finish their day at $t=1$.
Here the flow can be understood in two different ways which are not the same when using a battery.

\begin{figure}[!h]
\includegraphics[width=\linewidth]{flowInterpretation}
\end{figure}

The solution to avoid this problem was :
\begin{itemize}
\item
Find a pool of elementary cycle thanks to Johnsson's algorithm \cite{johnson_finding_1975};
\item
Find with Cplex a subset of cycle which forms a solution to this problem.
\end{itemize}

We didn't choose this solution since energy was hard to integrate and we had no assurance that the solution found would be optimal since the pool of elementary cycle is limited.\\
\textbf{Option 3 :} finally, we choose to study this problem by modifying the previous model and the TEG to be able to take the energy into account.

\subsection{Modified TEG}
As we saw in the previous chapter, the main problem when using flow to represent the solution is that a flow doesn't have an unique decomposition in car travel.
This wasn't a problem with non electric car, because if the car didn't have enough gas, the driver can fill up the car in two minutes.
But, with the energy, this is not possible.
We have to follow the car on every step to see if the battery can support this travel or not. 
In order to do that, we modify the graph as follow (\textbf{Figure 4.3}):
\begin{itemize}
\item
We use the same node;
\item
If the arc $a \in$ $\mathcal{A}_1 \cup \mathcal{A}_2$ (if it's a stock or a request) with  a capacity of  $u(a)$, create $u(a)$ arcs with a capacity of $1$;
\item
If the arc is a vehicle relocation arc, we create the same arc in the new graph with a capacity of 1.
\end{itemize}
This modification represents the same system except for the vehicle relocation. In this case, we want to limit the number of arcs in this new graph. So, we suppose that we can't have more than one employee at a precise time and station to do a vehicle relocation. Even with this constraint, the number of arcs increase.

\begin{figure}[!h]
\includegraphics[width=\linewidth]{tegTransformation}
\end{figure}

This modification increases the number of arc from $ N^2 \cdot T + M$ to $ N \cdot T \cdot (N+P) + M \cdot C$.
However, this modification allows to give an unique energy value to each arc.

\subsection{Notation}
We conserve the same notations as seen before with the previous model :

\begin{itemize}
\item N: The number of station possible;
\item T: The number of time step;
\item R: Number maximum of vehicle relocations;
\item C: The maximum  number of vehicle;
\item B: The maximum number of stations which can be construed;
\item $\epsilon_a$ = $\left\{
\begin{array}{l l}
1 & \text{if a is in the cut} \\
0 & \text{otherwise} \\
\end{array}
\right.$
\item $u(a)$: The capacity of the arc $a$ =$\left\{
\begin{array}{l l}
\text{number of parking spot} & \text{if a} \in \mathcal{A}_1\\
\text{number of request for this arc} & \text{if a} \in \mathcal{A}_2\\
1 & \text{if a} \in \mathcal{A}_3\\
\end{array}
\right.$
\end{itemize}

We also add two others notations due to the energy problem:
\begin{itemize}
\item E: the battery capacity (in Km);
\item $Gain_k$: Electric gain ($>0$) or cost ($<0$) of the arc $k$ which depend if the car is in stock or in travel.,
\end{itemize}

And finally, we add three notations: 
\begin{itemize}
\item
J: The maximum number of Jockeys available.
A jockey an employee of the operator of the carsharing system.
His/Her job consists on relocating cars to balance the system and thus accept more requests to relocate the car.
\item
$T_{relox}$: The different time step where a vehicle relocation is possible.
\item
$\mu_{at}$: It's a boolean which represent the time step of departure of an arc:
$\mu_{at} =\left\{
\begin{array}{l l}
1 & \text{If the arc a start at the time step t }\\
0 & \text{otherwise}
\end{array}
\right.$\\
\end{itemize}

We have also three variables :
\paragraph{Variables}
\begin{itemize}
\item
$ \varphi (a) = 1 $ if a flow use the arc $a$, $0$ otherwise.
This variable is the same as in the previous model except it's now a binary.
\item
$E_k$: Energy in the battery before using the arc $k$.
This variable allow us to check if the vehicle has enough energy to be able to use the arc.
It also gives us the battery level of the car in an unique way because the arc has a capacity of $1$.
\item
$A_{kj}$ = 1 if a flow use arc $k$ and continue with arc $j$, $0$ otherwise.
This variable allows us to follow every step of the car.
\end{itemize}

\subsection{Mathematical model}
Using the notations above, we can formulate our model as follows:
\begin{center}
 $$\ \ Max \sum_{a\in \mathcal{A}_2}  \varphi (a)\ \ \hspace{3cm} \qquad\emph{(0)}$$
\begin{tabular}{l l l}
\rule[-2ex]{0pt}{5ex}$\sum_{a \in \mathcal{A}_3} \varphi(a) \leq R$ & &$\qquad$\emph{(1)} \\
\rule[-2ex]{0pt}{5ex}$\sum_{a \in \mathcal{A}} \varphi(a) * \epsilon_{a} \leq C$ & &          $\qquad$\emph{(2)} \\
\rule[-2ex]{0pt}{5ex}$E_j \leq E_k + Gain_{k}*A_{kj} + E *(1-A_{kj}) $ & $\forall (k,j) \in \mathcal{A}^2$ & $\qquad$\emph{(3)}  \\
\rule[-2ex]{0pt}{5ex}$E_{k} \leq E_{j} + E *(1-A_{kj})$ & $\forall k\in \mathcal{A}_{1},\forall j \in \mathcal{A}$ & $\qquad$\emph{(4)} \\
\rule[-2ex]{0pt}{5ex}$\sum_{j} A_{kj} = \varphi(k)$ & $\forall k \in \mathcal{A}$& $\qquad$\emph{(5)} \\
\rule[-2ex]{0pt}{5ex}$\sum_{k} A_{kj} = \varphi(j)$ & $\forall j \in \mathcal{A}$& $\qquad$\emph{(6)} \\
\rule[-2ex]{0pt}{5ex}$\sum_{a\in \mathcal{A}_{3}} \varphi(a) * \mu_{at} \leq J$ &$\forall t \in T_{reloc} $ & $\qquad$\emph{(7)}\\
\rule[-2ex]{0pt}{5ex}$\sum_{k \in Station} s_{k} \leq B$ &  & $\qquad$\emph{(8)}\\
\rule[-2ex]{0pt}{5ex}$\varphi(k) \leq s_t $ & $ k \in \Gamma^{+}(s_t), \forall t \in Station$  & $\qquad$\emph{(9)}\\
\rule[-2ex]{0pt}{5ex}$0 \leq E_k \leq E$ & $\forall k \in \mathcal{A}$ & $\qquad$\emph{(10)} \\
\rule[-2ex]{0pt}{5ex}$A_{ij} \in \{0,1\}$ & $\forall (i,j) \in \mathcal{A}^2$ & $\qquad$\emph{(11)}\\
\rule[-2ex]{0pt}{5ex}$\varphi(k) \in \{0,1\}$ & $\forall k \in \mathcal{A}$ & $\qquad$\emph{(12)} \\
\end{tabular}
\end{center}
The objective function $(0)$ of this MILP maximizes the number of requests realised.
This model has nine sets of constraints.
Constraint $(1),(2),(8),(9)$ are the same as in the previous model.\\
Constraint $(3)$ updates the energy for a car which just takes the ark $k$ and will continue with the arc $j$.
It also check if the car has enough energy to use the arc $k$.
Finally, the last part of this constraint is a big M constraint to not constraint $E_{j}$ and $E_{k}$ when $A_{kj} = 0$.\\
Constraint $(4)$ forbid the car to loose energy when parked.
This is due to the fact that Cplex would often withdraw all the energy in the car when this energy wasn't needed, which was unrealistic.\\
Constraint $(5)$ and $(6)$ are the new flow conservation constraints.
It can be seen as follows (\textbf{Figure 4.4}):

\begin{figure}[!h]
\includegraphics[width=\linewidth]{flowConservation}
\end{figure}

For all arcs coming to A, at most one can continue with the arc $j$.
And if $\varphi (j)= 1$, then one and only one arc $i$ coming to $A$ has $A_{ij} = 1$ and one arc $k$ leaving from $B$ has $A_{jk} = 1$\\
Constraint $(7)$ is a new constraint added to takes the jockey into account.
So instead of having a global number of vehicle relocation, we have a number of possible employees working at a precise time.

\paragraph{Numbers of variables:}
We have : 
\begin{itemize}
\item N: number of stations;
\item M: number of requests;
\item R: number of time steps for a vehicle relocation;
\item T: number of time steps;
\item P: Average number of parking spots per station;
\item For $\varphi$ and  $E_{k}$ : $$\underbrace{M}_\textrm{number of requests} + \underbrace{P * N * T}_\textrm{number of stock} + \underbrace{R * N * (N -1)}_\textrm{number of vehicle relocations}$$
\item For $A_{ij}$ : $$\underbrace{2 * M * P }_\textrm{number of requests} + \underbrace{P^{2} * N * T}_\textrm{number of stock} + \underbrace{2* R * N * (N -1) * P}_\textrm{number of vehicle relocations}$$
\end{itemize}

\section{Advantages and inconveniences with this model}
This model provides us with an optimal solution for our model.
Moreover, it's a model quite natural.
However, this model has several issues:
\begin{itemize}
\item it has too much variables;
\item it has symmetry issues;
\item it doesn't give a good approximation when relaxed;
\item Cplex can only run small instances (7 stations) in an acceptable time.
\end{itemize}
Because of these issues, we have to try to improve the model.

\section{Improvement of the model}
We try three different improvements to be able to improve our model :
\begin{itemize}
\item Modify Cplex parameters;
\item Break the symmetry;
\item Give to Cplex a solution to start.
\end{itemize}

\section{Parameters}
One improvement of the model was to modify the Cplex parameters to fit our problem and thus be quicker.
We have found two parameters to improve the resolution:
\begin{itemize}
\item \emph{VarSel}:
the strategy choose the next branch that Cplex is going to explore.
In our solution, Cplex stays a long time on a branching node before opening a branch.
It reduces the time spent on each branch and reduce also the memory use.
\item \emph{RINSHeur}:
decides how often to apply the relaxation induced neighborhood search (RINS) heuristic.
It helps Cplex to quickly find a possible solution;
We also use different cuts to to accelerate the research, as for instance Gomory's cut.
\end{itemize}

\section{Symmetry}
One of the main drawback with this new TEG representation is the arc symmetry.
By multiplying the arc stocks, we created multiple solutions which are equivalent.

\begin{figure}[!h]
\includegraphics[width=\linewidth]{symetries}
\end{figure}

As we can see in \textbf{Figure 5.1}, there is no difference between paths $P_1$ and $P_2$ both in terms of interpretation and objective function value.
However, those are different paths so it will offer more possibles solutions to Cplex.
To break the symmetry, we consider for each node in the TEG with multiple variables $1_{ij}$ only those verifying: $\forall (i, i\prime) \in \mathcal{A}_1^{2},\forall (j, j\prime) \in \mathcal{A}_1^{2}, A_{ij} \neq A_{i\prime j\prime} \text{if} i \neq i\prime \text{and} j\neq j\prime $.
We can see it in the \textbf{Figure 5.2}.

In term of interpretation, this can represent a car in a parking spot.
This decrease the number of variables $A_{ij}$ for each node from $|\Gamma^{-}(x)|*|\Gamma^{+}(x)|$ to $|\Gamma^{-}(x)|$.
The total number of variable $A_{ij}$ in the TEG can be calculated as follow: 

\begin{itemize}
\item
For $A_{ij}$ before the symmetry break: $$\underbrace{2 * M * P }_\textrm{number of requests} + \underbrace{P^{2} * N * T}_\textrm{number of stock} + \underbrace{2* R * N * (N -1) * P}_\textrm{number of vehicle relocation}$$
\item
For $A_{ij}$ after: $$\underbrace{2 * M * P }_\textrm{number of request} + \underbrace{P * N * T}_\textrm{number of stock} + \underbrace{2* R * N * (N -1) * P}_\textrm{number of vehicle relocation}$$
$$ = P * ( 2M + N * (T + 2R * (N-1)))$$
\end{itemize}
With:
\begin{itemize}
\item N: number of stations;
\item M: number of requests;
\item R: number of time steps for a vehicle relocation;
\item T: number of time steps;
\item P: average number of parking spot per station.
\end{itemize}
As we can see, this modification reduce the number of $A_{ij}$ by a $P$ factor.

\section{Rounding}
One manner to improve the resolution time is to initialise Cplex with a solution, feasible or not.
We investigate two type of solutions:
\begin{itemize}
\item Rounding technique;
\item Heuristic.
\end{itemize}
Our rounding solution can be find following:

\begin{enumerate}
\item Solve the problem relaxed for all the variables except for the stations;
\item Variable value :$\left\{
\begin{array}{l l}
if > 0.7 & \text{then fix at 1;} \\
if < 0.3 & \text{then fix at 0;} \\
otherwise & \text{keep the same value.}
\end{array}
\right.$
\item Either let Cplex try to repair the solution or try to repair the solution by hand;
\item Give this solution to Cplex to do a warm start.
\end{enumerate}

We implemented this solution but unfortunately, Cplex was not able to repair it.
So, we give up on this solution and try to create an heuristic which can provide a feasible solution.

\section{Heuristic}
Our heuristic is a modified Dijkstra's algorithm.
This is due to the fact that our model can be reformulated as a k-minimum path problem with constraints.
As weight on the arcs, we set: 
\begin{itemize}
\item 0 for request arcs;
\item 1 for stock and vehicle relocation arcs.
\end{itemize}
The heuristic search for $C$ minimum paths verifying energy and vehicle relocation constraints.
These paths have to be cycle due to the following property 
\begin{prop}
Every solution of the problem of dimensioning can be decompose in k-cycle, $k \in [1,C]$ with length $l*T, l\in [1,C]$.
\end{prop}

This property was proved on the paper \cite{carlier_optimization_2014b}

To fulfil the energy constraints, we label every node in the graph with a list of couples.
Those couples keep on the one hand the value of the solution, and on the other hand the remaining energy in the car.
Every couple with a higher solution value and a lower energy value can be suppressed from the list.
The algorithm can be expressed as in the \textbf{Algorithm 1} and we can see an example of this heuristic in the \textbf{Figure 5.3}.

\begin{figure}[!h]
\includegraphics[width=\linewidth]{heuristicExample}
\end{figure}

It should be noted that the solution found by \textbf{Algorithm 1} can be non-optimal because when the algorithm take a best path, it can block future better path starting from other nodes. 
This heuristic also makes only a cycle with length of $T$ which can result in lower result.

\begin{algorithm}
\DontPrintSemicolon % Some LaTeX compilers require you to use \dontprintsemicolon instead
\KwIn{A TEG : $teg$ , a depart node : $depart$}
\KwOut{Value of the best path from $depart$ to $depart$ with energy }
\For{each node}{
List $\gets$ $(0,0)$ if $depart$ node\;
List $\gets$  (+$\infty,0$) other node\; 
}
\While{$List \neq \phi$} {
couple $\gets$ couple $\in$ List with the smallest cost\;
 \If{$node(couple) == depart$}{
 \Return {$getcost(couple)$}\;
 
 }
 node $\gets$ node(couple)\;
\For{any arc adjacent}{
 $arrive \gets arc destination$\;
 $cost \gets getcost(couple)$\;
 $energy \gets getenergy(couple)$\;
  \If{$arc$ is not a request} {
    $cost \gets cost + 1$\tcp*{\small{Update cost}}
   }
   $energy \gets energy + arc(energy)$\tcp*{Update battery charge}
   \If{$energy \geq 0$ }{
   	\For{every couple in $arrive$}{
   	\If{$energy \geq getenergy(couple)$ and $cost \leq getcost(couple)$}{
 		suppress couple\tcp*{This couple is worst}
  		}
   	\If{$energy \leq getenergy(couple)$ and $cost \geq getcost(couple)$}{
  	 $break$\tcp*{A better solution exist}
 	 }
 	}
  }
  }
}
\caption{Heuristic to find the best path}
\label{algo:max}
\end{algorithm}

\section{Results}
The optimisation models and heuristic were run in an Intel¬Æ Xeon¬Æ processor 3.10 GHz, 16Gb RAM computer under Ubuntu using Cplex as a solver.
The code was written in java with the java API of Cplex. 

\subsection{Resolution time}
The first result we try to have is to know which instance we can resolve in a reasonable time.
The \textbf{Figure 6.3} gives us the resolution time for instances between 10 and 30 stations.
We can see that for 30 stations, some instances need 32 hours to be resolved.
Also, we can see that the heuristic have an impact for small instance but with 30 stations, it can have a impact null or even a bad impact. 

~\\~\\~\\Figure\\~\\~\\

We can also notice that the y axis is on a logarithmic scale which tell us that the time to solve an instance is exponential on the number of station.

\subsection{Energy versus no energy}
Our second experiment was to see the impact of the electric car opposed to fuel car in an optimal solution.
The \textbf{Figure 6.4} show us the difference in the number of request accepted, car used and vehicle relocation in each solution.
The number of request accepted stay the same with or without energy.
However, a solution with energy requires in average more cars  than a solution without.
If we restrain the number of car, then the energy solution cannot achieves the same number of request accepted than the solution without energy.
So, even if the solution seems to be equal in term of accepted request, the solution with  the energy constraint is different from a solution without such constraint.

\begin{figure}
\begin{tabularx}{\textwidth}{|X|c|c|c|c|}
\hline
Instances & Nb stations & Nb requests & Nb cars & Nb veh-reloc \\
\hline
Without energy & 10 & 74 & 12 & 20 \\
With energy & 10 & 74 & 14 & 19\\
\hline
With energy restraint \newline to 12 cars and 20 \newline vehicle relocations & 10 & 72 & 12 & 14\\
\hline  
Without energy & 20 & 361 & 60 & 50 \\
With energy & 20 & 361 & 60 & 50 \\
\hline
Without energy & 30 & 461 & 83 & 50\\
With energy & 30 & 461 & 84 & 50\\
\hline
Without energy & 50 & 790 & 149 & 50\\
With energy & 50 & 790 & 149 & 50\\
\hline
\end{tabularx}
\caption{Impacts of the energy on solutions}
\end{figure}

\subsection{Energy result}
The last experiment was to see how each car and station were used in a optimal solution with energy constraint.
We choose to create instances with the same ratio between station number, car and request as in the autolib system in Paris.
This mean for a system with $N$ stations, we have 3 x $N$ cars and 20 x $N$ requests.
The \textbf{Figure 6.5} shows the results for different instances.
We evaluate the average number of request, number of vehicle relocation, battery level and time spent in station of a car in an optimal solution.
The last column gives us the average energy a station delivers in a solution in comparison to maximum energy possible to delivers by a station.\\

\begin{figure}[h]
\newcolumntype{C}{>{\centering\arraybackslash}X}
\begin{tabularx}{\textwidth}{|C|C|C|C|C|C|}
\hline
Nb Stations & Nb requests done by a car & Nb veh-reloc by a car & Battery level ($\%$) & Time in station ($\%$) & Energy delivers by a station ($\%$)\\
\hline
10 & 6.06 & 0.96 & 35.21 & 73.65 & 37.48 \\
\hline
20 & 6.01 & 0.83 & 28.63 & 75.57 & 28.38 \\
\hline
30 & 5.48 & 0.76 & 33.39 & 71.43 & 27.42 \\
\hline
50 & 5.28 & 0.33 & 22.66 & 75.00 & 23.89 \\
\hline
\end{tabularx}
\caption{Results on average for a solution with energy}
\end{figure}

This result shows us that even if the energy has an impact in the solution as seen in \textbf{Figure 6.4}, the impact is small.
Indeed, a car stay in station almost $75\%$ of the day but has very low battery level.
And thanks to the last column, we can see that a car spends time in station without charging.
This show that in a system with the same proportion as autolib, the electric component isn't such a constraint as we might except. 
\newpage

\section{Conclusion}
\subsection{Results}
In conclusion, we have developed a model to solve the localisation and dimensioning problem with electric constraints. We also produced a state of the art on this problem. However, due to the complexity of this problem, Cplex was not able to solve it in a reasonable time on instances containing more than $10$ stations. To cope with that, we improved the model by breaking symmetries. We also developed an rounding technique and an heuristic. However the rounding technique didn't give any results.
We were able to see the impacts of electric constraints in such problem. We saw that the electric constraints have an impact on the solution. However, we need to try in a system with more constraints to be able to see the impact.
\subsection{Further research}
There are several possible ways to pursuit and improve the resolution of this problem. One way would be to modify the model to take into account the possible path instead of arcs as variables and run a column generation method with a branch and price. Another solution would be to improve the heuristic by using a meta heuristic. Further research can also focus on the impact of electricity in system with a lower ratio vehicle/request.

\newpage
\addcontentsline{toc}{section}{Bibliography of chapter \thechapter}
\renewcommand{\bibname}{Bibliography of chapter \thechapter}
\putbib[bib/biblio]
\end{bibunit}
